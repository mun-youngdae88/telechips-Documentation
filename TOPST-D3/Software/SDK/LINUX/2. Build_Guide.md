# 2. Build Guide

<br/><br/>

## 2.1 TOPST D3 Linux SDK Build Prepration

TOPST D3 Linux SDK is based on Yocto Project 3.1 Dunfell. Therefore, the Yocto Project environment must be set on the host PC to use TOPST D3 Linux SDK. To download SDK, source-mirror, and tools, you must install utilities.  

<br/><br/>

## 2.2 Yocto Project  

The Yocto Project is an open source project focuses on embedded Linux development.  
It uses a combination of Open Embedded project, which is Poky, and ***bitbake*** as the build system to make Linux images.  
By using Yocto Project, you can simultaneously build the bootloader, kernel, and rootfs.  

<br/><br/>

## 2.3 Task Process

Figure 2.1 shows the task process of Yocto Project. You can download source from upstream based on metadata and build it. After the build is completed, package, image, and SDK are provided as results.

<p align="center">
    <img src="https://github.com/Topst-Dev/Documentation/assets/144076415/daa02968-b0b5-4ff2-8dd0-65edd6393f45" width="750" height="400">
</p>
<p align="center"><strong>Figure 2.1 Yocto Project Task Process</strong></p>

There is one ways to download and build TOPST D3 Linux SDK as follows:

- Manual operation


<br/><br/>

### 2.4.2 Composition of TOPST D3 SDK

<br/>

<table align="center">
  <tr>
    <th colspan="3">File</th>
    <th>Description</th>
  </tr>
  <tr>
    <td colspan="3">easy-setup.sh</td>
    <td>Python script to automatically download and build the SDK</td>
  </tr>
  <tr>
    <td colspan="3">stitch-fai.sh</td>
    <td>Script for making fai image(minimal + GStreamer + Qt)</td>
  </tr>
  <tr>
    <td rowspan="7">tools</td>
    <td colspan="2">README.md</td>
    <td rowspan="7">Tools related build</td>
  </tr>
  <tr>
    <td colspan="2">easy-setup.sh</td>
  </tr>
  <tr>
    <td colspan="2">mktcimg</td>
  </tr>
  <tr>
    <td colspan="2">stitch-fai.sh</td>
  </tr>
  <tr>
    <td colspan="2">fwdn</td>
  </tr>
  <tr>
    <td colspan="2">partition.dual.list</td>
  </tr>
  <tr>
    <td colspan="2">partition.single.list</td>
  </tr>
  <tr>
    <td rowspan="14">yocto</td>
    <td colspan="2">poky</td>
    <td>Yocto Project 1.1 Dunfell build system</td>
  </tr>
  <tr>
    <td colspan="2">meta-arm</td>
    <td>Support Arm toolchain Layer</td>
  </tr>
  <tr>
    <td colspan="2">meta-qt5</td>
    <td>Support Qt5 5.6.3 Layer</td>
  </tr>
  <tr>
    <td colspan="2">meta-telechips-bsp</td>
    <td>Support Telechips BSP Layer</td>
  </tr>
  <tr>
  <tr>
    <td colspan="2">meta-gplv2</td>
    <td>Support packages to avoid GPLv3 license</td>
  </tr>
  <tr>
    <td rowspan="5">meta-telechips</td> 
    <td>meta-core</td>
    <td>Recipes that require modification from Open Source Software (OSS) used by Telechips TOPST D3 SDK or recipes that are not in Yocto Project 3.1</td>
  </tr>
  <tr>
    <td>meta-extra</td>
    <td>OSS Layer that is added by Telechips</td>
  </tr>
  <tr>
    <td>meta-qt5</td>
    <td>Support Qt5 to support Telechips GUI application</td>
  </tr>
  <tr>
    <td>meta-ivi</td>
    <td>Configuration package and example programs of In-vehicle Infotainment (IVI)</td>
  </tr>
  <tr>
    <td>meta-subcore</td>
    <td>Configuration package and example programs on sub-core</td>
  </tr>
  <tr>
    <td colspan="2">meta-topst</td>
    <td>Maincore recipe</td>
  </tr>  
  <tr>
    <td colspan="2">meta-topst-subcore</td>
    <td>Subcore recipe</td>
  </tr>
</table>

<br/>

### 2.4.1 Create and regist SSH Key

```
$ ssh-keygen
$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAA ... MYFI4PP8kik= ben@topst
```
<br/>

After you create SSH Key, register your SSH Key in [GITLAB](https://gitlab.com/-/user_settings/ssh_keys). 

<p algin="center"><img src="https://github.com/topst-development/Documentation/assets/161264431/1b888871-d8a7-4adb-9d33-d6c839168e00"></p>
<p align="center"><strong>Figure 2.2 Register SSH Key</strong></p>

<br/>

### 2.4.2 Create SSH config

```
$ vi ~/.ssh/config

Host gitlab.com
    User git
    IdentityFile ~/.ssh/id_rsa
    UpdateHostKeys yes
```
<br/>


### 2.4.3 Get TOPST-D3 with Git

```
$ mkdir topst
$ cd topst

$ repo init -u https://gitlab.com/topst.ai/manifests -m topst-d3-pre-v0.1.xml
Downloading Repo source from https://gerrit.googlesource.com/git-repo

... A new version of repo (2.45) is available.
... New version is available at: /home/ben/topst/.repo/repo/repo
... The launcher is run from: /usr/bin/repo
!!! The launcher is not writable.  Please talk to your sysadmin or distro
!!! to get an update installed.


Your identity is: Seonguk Nam <topstdeveloper@gmail.com>
If you want to change this, please re-run 'repo init' with --config-name

repo has been initialized in /home/ben/topst

$ repo sync

... A new version of repo (2.45) is available.
... New version is available at: /home/ben/topst/.repo/repo/repo
... The launcher is run from: /usr/bin/repo
!!! The launcher is not writable.  Please talk to your sysadmin or distro
!!! to get an update installed.

Fetching: 100% (9/9), done in 13.638s
Checking out: 100% (9/9), done in 0.510s
repo sync has finished successfully.
```

<br/>



### 2.4.4 Execute Build Script

```
$ ./easy-setup.sh 
[+] Please execute the following command to initiate the build process

	source yocto/poky/oe-init-build-env build-main
	bitbake topst

[!] Will you use subcore? (yes/no) no
```
```
$ source yocto/poky/oe-init-build-env build-main

### Shell environment set up for builds. ###

You can now run 'bitbake <target>'

Common targets are:
    core-image-minimal
    core-image-sato
    meta-toolchain
    meta-ide-support

TOPST common targets are:
    topst-minimal
    topst-multimedia    (minimal + GStreamer)
    topst               (minimal + GStreamer + Qt)

Other commonly useful commands are:
 - 'devtool' and 'recipetool' handle common recipe tasks
 - 'bitbake-layers' handles common layer tasks
 - 'oe-pkgdata-util' handles common target package tasks
Warning: source-mirror not exist!!
         The build to be slowler or fail because will be download source code from upstream before build.


$ bitbake topst
```
<br/>


### 2.5.5 Make FWDN Image

This option creates a binary into one image for TOPST D3 platform image. The following is a list of images that are created with this option.

<br/>

The output.fwdn.win.zip including “Output.fai” build image and fwdn tools is created in the following path:

- {TOPST_PATH}/

```
$ ./stitch-fai.sh -f

Filesystem too small for a journal
[mktcimg] v1.2.1 - Nov 15 2021 19:33:18
location : bl3_ca72_a
location : 4096 sector(2097152 byte)
location : build-main/tmp/deploy/images/tcc8050-main/ca72_bl3.rom
location : boot
location : 122880 sector(62914560 byte)
location : build-main/tmp/deploy/images/tcc8050-main/tc-boot-tcc8050-main.img
location : system
location : 11534336 sector(5905580032 byte)
location : build-main/tmp/deploy/images/tcc8050-main/topst-tcc8050-main.ext4
location : dtb
location : 400 sector(204800 byte)
location : build-main/tmp/deploy/images/tcc8050-main/tcc8050-linux-topst-d3-pre-v0.1.dtb
location : env
location : 2048 sector(1048576 byte)
location : misc
location : 2048 sector(1048576 byte)
location : splash
location : 81920 sector(41943040 byte)
location : home
location : 3516416 sector(1800404992 byte)
location : ./.stitch_X4auAMf/home-directory.ext4
location : data
location : 2048 sector(1048576 byte)
location : ./.stitch_X4auAMf/user-data.ext4
path : build-main/tmp/deploy/images/tcc8050-main/ca72_bl3.rom
uuid : 6ae3fc58-8a4e-4fc9-8cca-1c603790743f , part-name : bl3_ca72_a
uuid : f789e929-094d-463a-84cf-ef82fd75caae , part-name : boot
uuid : 7cb2f188-f31b-4523-9650-1d64b6d67442 , part-name : system
uuid : dec814d0-86a3-4f29-a281-abf2b93ee58a , part-name : dtb
uuid : e24176e6-e5a2-49fe-8a08-2bf64e992455 , part-name : env
uuid : e2f8ee6b-b642-4a71-b0f6-b6efaa05890e , part-name : misc
uuid : 63e046e0-e5fb-460e-8918-e041dc88bd8c , part-name : splash
uuid : 2953de56-2ae8-45be-b45e-2b9d6f4259d2 , part-name : home
uuid : 6dfc3dd8-16b4-421c-9480-a32ef8a9c9c9 , part-name : data
crc32 of header : 1924a4bb
crc32 of partition array : e02f9280
idx : 0  bl3_ca72_a
idx : 1  boot
idx : 2  system
idx : 3  dtb
idx : 7  home
idx : 8  data
crc32 of header : 1924a4bb
crc32 of partition array : 27876c54
Complete to make fai file

===== arguments info =====

--storage_size : 7818182656
--parttype : gpt
--area_name : "SD Data"
--outfile : ./.stitch_X4auAMf/output.fai
--gptfile : ./.stitch_X4auAMf/output.gpt
--fplist : ./.stitch_X4auAMf/partition.single.list
--sector_size : 512
--sparse_fill : 0

===========================

[+] Packaging Windows FWDN
  adding: output.fai (deflated 97%)
  adding: fwdn.bat (deflated 40%)
  adding: fwdn.exe (deflated 57%)
  adding: VtcUsbPort.dll (deflated 64%)
  adding: boot-firmware/ (stored 0%)
```
